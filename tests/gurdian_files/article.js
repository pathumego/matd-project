define("text!common/views/content/richLinkTag.html",[],function(){return'<aside class="element element-rich-link element-rich-link--tag element--thumbnail element-rich-link--not-upgraded" data-component="rich-link-tag" data-link-name="rich-link-tag">\n    <p><a href="<%=href%>"><%=href%></a></p>\n</aside>\n'}),define("common/modules/article/rich-links",["fastdom","qwery","Promise","common/utils/$","common/utils/ajax-promise","common/utils/config","common/utils/detect","common/utils/mediator","common/utils/template","common/modules/article/spacefinder","common/modules/ui/images","text!common/views/content/richLinkTag.html","lodash/collections/contains"],function(e,t,o,n,s,i,r,a,c,m,l,d,u){function p(t){var i=n("a",t).attr("href"),r=i.match(/(?:^https?:\/\/(?:www\.|m\.code\.dev-)theguardian\.com)?(\/.*)/);return r&&r[1]?s({url:"/embed/card"+r[1]+".json",crossOrigin:!0}).then(function(o){o.html&&e.write(function(){n(t).html(o.html).removeClass("element-rich-link--not-upgraded").addClass("element-rich-link--upgraded"),l.upgradePictures(t),n(".submeta-container--break").removeClass("submeta-container--break"),a.emit("rich-link:loaded",t)})}):o.resolve(null)}function h(){return{minAbove:200,minBelow:250,clearContentMeta:50,selectors:{" > h2":{minAbove:"mobile"===r.getBreakpoint()?20:0,minBelow:200}," > *:not(p):not(h2):not(blockquote)":{minAbove:35,minBelow:300}," .ad-slot":{minAbove:150,minBelow:200}," .element-rich-link":{minAbove:500,minBelow:500}}}}function f(){var t=n(".element-rich-link a").map(function(e){return n(e).attr("href")}),s=function(e){return u(i.page.richLink,e)},r=t.some(s),a=i.page.shouldHideAdverts||!i.page.showRelatedContent;return!i.page.richLink||-1!==i.page.richLink.indexOf(i.page.pageId)||a||r?o.resolve(null):m.getParaWithSpace(h()).then(function(t){return new o(function(o){t?e.write(function(){var e=n.create(c(d,{href:i.page.richLink}));e.insertBefore(t),o(p(e[0]))}):o(null)})})}function g(){n(".element-rich-link--not-upgraded").each(p)}return{upgradeRichLink:p,upgradeRichLinks:g,insertTagRichLink:f,getSpacefinderRules:h}}),define("common/modules/article/membership-events",["fastdom","common/utils/$","common/utils/ajax-promise"],function(e,t,o){function n(n){var s=t("a",n).attr("href"),a=s.match(/https:\/\/membership.theguardian.com/);a&&o({url:s+"/card",crossOrigin:!0}).then(function(o){o.html&&e.write(function(){t(n).html(o.html).removeClass(i).addClass(r)})})}function s(){t("."+i).each(n)}var i="element-membership--not-upgraded",r="element-membership--upgraded";return{upgradeEvent:n,upgradeEvents:s}}),define("common/modules/article/open-module",["fastdom","common/utils/$","common/utils/ajax","common/utils/config","common/utils/detect","common/modules/article/spacefinder"],function(e,t,o,n,s,i){function r(){return{minAbove:200,minBelow:250,clearContentMeta:50,selectors:{" > h2":{minAbove:"mobile"===s.getBreakpoint()?20:0,minBelow:200}," > *:not(p):not(h2)":{minAbove:35,minBelow:300}," .ad-slot":{minAbove:150,minBelow:200}," .element-rich-link":{minAbove:400,minBelow:400}}}}return{init:function(){n.page.openModule&&i.getParaWithSpace(r()).then(function(s){s&&o({url:n.page.openModule,crossOrigin:!0,method:"get"}).then(function(o){o.html&&e.write(function(){t.create(o.html).addClass("element--supporting").insertBefore(s),t(".submeta-container--break").removeClass("submeta-container--break")})})})}}}),define("common/modules/article/chapters",["bean","common/utils/$"],function(e,t){return{init:function(){this.bindEvents()},bindEvents:function(){e.on(document.body,"click",".js-toggle-chapters",function(){this.toggleChapters()}.bind(this))},toggleChapters:function(){t(".chapters").toggleClass("is-expanded")}}}),define("fence",[],function(){function e(t,o,n,s){s=s||0,t(),o>0&&setTimeout(function(){var i=n+s;e(t,o-1,i,n)},n)}function t(t){setTimeout(function(){e(function(){r(t),a(t)},h,p)},0)}function o(e,t){return e.classList?e.classList.contains(t):-1!==e.className.indexOf(t)}function n(e,t){return e.classList?e.classList.add(t):e.className+=" "+t}function s(){for(var e="iframe."+d,t=document.querySelectorAll(e),o=0,n=t.length;n>o;++o)i(t[o])}function i(e,s){if(s=s||{},"IFRAME"!==e.tagName)throw new Error("Cannot render non-iframe elements!");if(!o(e,d))throw new Error("Cannot render iframes with no "+d+" class!");var i=o(e,u);if(!i||s.force){e.style.height=0,e.frameBorder=0,e.style.border="none",e.style.overflow="hidden",e.width="100%";var r=!!e.srcdoc;if(r)"complete"===e.contentWindow.document.readyState?t(e):i||e.addEventListener("load",function(){t(e)},!1);else{var a=e.getAttribute("srcdoc");a&&"string"==typeof a&&(e.contentWindow.contents=a,e.src='javascript:window["contents"]',t(e))}n(e,u)}}function r(e){var t=e.contentWindow&&e.contentWindow.document,o=t&&t.body;o&&(o.style.padding=0,o.style.margin=0,o.style.overflow="hidden")}function a(e){var t=e.contentWindow&&e.contentWindow.document;if(t){var o=t.documentElement&&t.documentElement.scrollHeight||t.body&&t.body.scrollHeight||0;e.style.height=o+"px"}}function c(e){var t=document.createElement("div");t.innerHTML=(e||"").trim();var o=t.firstChild,n=o&&"IFRAME"===o.tagName,s=o&&!o.nextSibling;return n&&s}function m(e){var t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML}function l(e){if(c(e))return e;var t=m(e).replace(/\"/g,"&quot;"),o="<html><head></head><body>"+t+"</body></html>";return'<iframe srcdoc="'+o+'" class="'+d+'"></iframe>'}var d="fenced",u="fenced-rendered",p=300,h=12;return{render:i,renderAll:s,isSafeCode:c,wrap:l}}),define("common/modules/article/twitter",["bean","bonzo","qwery","fastdom","common/utils/$","common/utils/config","common/utils/detect","common/utils/mediator","lodash/functions/debounce"],function(e,t,o,n,s,i,r,a,c){function m(){a.on("window:throttledScroll",c(l,200))}function l(){if("mobile"!==r.getBreakpoint()&&i.switches.enhanceTweets){var e=o("blockquote.js-tweet"),a=t.viewport().height,c=window.pageYOffset;e.forEach(function(e){var o=t(e),i=o.offset();c+2.5*a>i.top&&c<i.top+i.height&&n.write(function(){s(e).removeClass("js-tweet").addClass("twitter-tweet"),d()})})}}function d(){var e,t=o("blockquote.twitter-tweet"),n=o("#twitter-widget");t.length>0&&(0===n.length&&(e=document.createElement("script"),e.id="twitter-widget",e.async=!0,e.src="//platform.twitter.com/widgets.js",s(document.body).append(e)),"undefined"!=typeof twttr&&"widgets"in twttr&&"load"in twttr.widgets&&twttr.widgets.load(u))}var u=o(".js-liveblog-body, .js-article__body");return{init:m,enhanceTweets:l}}),define("common/modules/article/truncate-liveblog",["common/utils/$","bean","bonzo","qwery","common/utils/config","common/utils/detect","common/utils/mediator","common/views/svgs","common/modules/article/twitter","lodash/collections/find"],function(e,t,o,n,s,i,r,a,c,m){function l(){e(".truncated-block blockquote.tweet-truncated").removeClass("tweet-truncated").addClass("js-tweet"),v.removeClass(p),e(".article-elongator").addClass("u-h"),c.enhanceTweets()}function d(){var e=window.location.hash.slice(1);return m(g,function(t){return t.id===e})}function u(){var o=f.length,n=o-h,i="";s.page.isLiveBlog&&o>h&&!d()&&(i=1===n?"View 1 more update":"View "+n+" more updates",e.create('<button class="u-button-reset button button--large button--show-more liveblog__show-more article-elongator" data-link-name="continue reading" data-test-id="article-expand">'+a("plus",["icon"])+i+"</button>").each(function(t){e(".js-liveblog-body").append(t)}),t.on(document.body,"click",".article-elongator",l.bind(this)),r.on("module:liveblog:showkeyevents",l.bind(this)),r.on("module:filter:toggle",l.bind(this)),v.addClass(p),e(".truncated-block blockquote.tweet").removeClass("js-tweet").addClass("tweet-truncated"))}var p="truncated-block",h="mobile"===i.getBreakpoint()?5:10,f=n(".block"),g=f.slice(h),v=o(g);return u}),define("common/utils/clamp",["bonzo","bean"],function(e,t){var o=function(o,n,s){var i,r=o.clientHeight,a=getComputedStyle(o).getPropertyValue("line-height"),c=(parseInt(a,10)+(s?2:0))*n,m=e(e.create('<span class="clamp-fade"></span>')),l=e(o);c>r||(l.css({maxHeight:c+"px",overflow:"hidden"}),l.after(m),s&&(i=e(e.create('<span class="clamp-fade__content u-fauxlink" role="button">Read more</span>')),m.append(i),t.on(i[0],"click",function(){m.remove(),l.css({maxHeight:"none",overflow:"auto"})})))};return o}),define("common/modules/open/cta",["common/utils/$","common/utils/clamp","common/modules/component"],function(e,t,o){var n=function(e,t){this.mediator=e,this.setOptions(t)};return o.define(n),n.prototype.endpoint="/open/cta/article/:discussionKey.json",n.prototype.componentClass="comment",n.prototype.useBem=!0,n.prototype.defaultOptions={discussionKey:null},n.prototype.prerender=function(){var t=e(".comment",this.elem),o=t[Math.floor(Math.random()*t.length)+0];0===t.length?this.destroy():this.elem=o},n.prototype.ready=function(){t(this.getElem("body"),10,!0)},n}),define("common/modules/ui/last-modified",["bean","fastdom","qwery","common/utils/$"],function(e,t,o,n){return function(){var s=n(".js-lm");s&&(t.write(function(){n(".js-wpd").addClass("content__dateline-wpd--modified tone-colour")}),e.on(o(".js-wpd")[0],"click",function(){t.write(function(){s.toggleClass("u-h")})}))}}),define("common/utils/client-rects",[],function(){var e,t=function(){if(void 0===e){var t=document.createElement("p"),o=document.createElement("p"),n=document.createTextNode("aa"),s=document.createTextNode("aa"),i=document.createRange();t.appendChild(n),o.appendChild(s),document.body.appendChild(t),document.body.appendChild(o),i.setStart(n,1),i.setEnd(s,1),e=i.getClientRects().length>2,document.body.removeChild(t),document.body.removeChild(o)}return e},o=function(e){if(!t())return e.getClientRects();for(var o=[],n=e.endContainer,s=e.endOffset,i=document.createRange();n!==e.commonAncestorContainer;)i.setStart(n,0),i.setEnd(n,s),Array.prototype.push.apply(o,i.getClientRects()),s=Array.prototype.indexOf.call(n.parentNode.childNodes,n),n=n.parentNode;return i=e.cloneRange(),i.setEnd(n,s),Array.prototype.push.apply(o,i.getClientRects()),o},n=function(e){var n,s,i,r=o(e),a=e.getBoundingClientRect();if(0===r.length)return null;if(!t())return e.getBoundingClientRect();if(0===a.width&&0===a.height)return r[0];for(n=0,s=r.length;s>n;n++)i=i||{left:r[n].left,top:r[n].top,right:r[n].right,bottom:r[n].bottom},i.left=Math.min(i.left,r[n].left),i.top=Math.min(i.top,r[n].top),i.right=Math.max(i.right,r[n].right),i.bottom=Math.max(i.bottom,r[n].bottom);return i&&(i.width=i.right-i.left,i.height=i.bottom-i.top),i};return{getClientRects:o,getBoundingClientRect:n}}),define("text!common/views/ui/selection-sharing.html",[],function(){return'<div class="selection-sharing">\n    <ul class="social u-unstyled u-cf" data-component="social-selection">\n        <li class="social__item" data-link-name="twitter">\n            <a  class="rounded-icon social-icon social-icon--twitter js-selection-twitter"\n                data-link-name="social-selection"\n                target="_blank"\n                href="#">\n                <span class="u-h">Share on Twitter</span>\n                <%= twitterIcon %>\n            </a>\n        </li>\n        <li class="social__item" data-link-name="email">\n            <a  class="rounded-icon social-icon social-icon--email js-selection-email"\n                data-link-name="social-selection"\n                target="_blank"\n                href="#">\n                <span class="u-h">Share via Email</span>\n                <%= emailIcon %>\n            </a>\n        </li>\n    </ul>\n</div>\n'}),define("common/modules/ui/selection-sharing",["bean","bonzo","common/utils/$","common/utils/client-rects","common/utils/config","common/utils/detect","common/utils/mediator","common/utils/template","text!common/views/ui/selection-sharing.html","common/views/svgs","lodash/functions/debounce","lodash/functions/throttle","lodash/collections/some"],function(e,t,o,n,s,i,r,a,c,m,l,d,u){var p,h,f=t(document.body),g=m("shareTwitter",["icon"]),v=m("shareEmail",["icon"]),b=a(c,{twitterIcon:g,emailIcon:v}),y=o.create(b),w=s.page.shortUrl+"/stw",C="https://twitter.com/intent/tweet?text=%E2%80%9C<%=text%>%E2%80%9D&url=<%=url%>",k=115,T=s.page.shortUrl+"/sbl",j="mailto:?subject=<%=subject%>&body=%E2%80%9C<%=selection%>%E2%80%9D <%=url%>",S=["js-article__body","content__standfirst","block","caption--main","content__headline"],E=function(){var e,t,o,i,r,c,m=window.getSelection&&document.createRange&&window.getSelection();if(m&&m.rangeCount>0&&m.toString()){if(e=m.getRangeAt(0),t=n.getBoundingClientRect(e),o=f.scrollTop()+t.bottom,i=e.toString(),!R(e))return void x();i.length>k&&(i=i.slice(0,k-1)+"…"),r=a(C,{text:encodeURI(i),url:encodeURI(w)}),c=a(j,{subject:encodeURI(s.page.webTitle),selection:encodeURI(e.toString()),url:encodeURI(T)}),p.attr("href",r),h.attr("href",c),y.css({top:o+"px",left:t.left+"px"}),_()}else x()},x=function(){y.hasClass("selection-sharing--active")&&y.removeClass("selection-sharing--active")},_=function(){y.hasClass("selection-sharing--active")||y.addClass("selection-sharing--active")},I=function(e){o.ancestor(e.target,"social__item")||x()},P=function(){i.hasTouchScreen()||(f.append(y),p=o(".js-selection-twitter"),h=o(".js-selection-email"),e.on(document.body,"keypress keydown keyup",l(E,50)),e.on(document.body,"mouseup",l(E,200)),e.on(document.body,"mousedown",l(I,50)),r.on("window:resize",d(E,50)))},R=function(e){return u(S,function(t){return o.ancestor(e.startContainer,t)&&o.ancestor(e.endContainer,t)})};return{init:P,updateSelection:E}}),define("bootstraps/article-liveblog-common",["fence","common/utils/$","common/utils/config","common/utils/mediator","common/utils/robust","common/modules/article/truncate-liveblog","common/modules/article/twitter","common/modules/open/cta","common/modules/ui/last-modified","common/modules/ui/rhc","common/modules/ui/selection-sharing"],function(e,t,o,n,s,i,r,a,c,m,l){function d(){if(o.switches.openCta&&o.page.commentable){var e=new a(n,{discussionKey:o.page.shortUrl.replace("http://gu.com/","")});t.create('<div class="open-cta"></div>').each(function(t){e.fetch(t),o.page.isLiveBlog||m.addComponent(t)})}}function u(){t(".fenced").each(function(t){e.render(t)})}function p(){i(),r.init(),r.enhanceTweets()}return function(){s.catchErrorsAndLogAll([["trail-article",d],["trail-fence",u],["trail-twitter",p],["trail-sharing",l.init],["trail-last-modified",c]])}}),define("enhancer",[],function(){function e(e,t,o,n){var s=e.getAttribute("data-interactive");require([s],function(s){s.boot(e,t,o,n)})}return{render:e}}),define("common/utils/contains",[],function(){return function(e,t){for(var o=0;o<e.length;++o)if(e[o]===t)return!0;return!1}}),define("common/utils/proximity-loader",["bonzo","common/utils/mediator","fastdom","lodash/collections/filter","lodash/functions/debounce"],function(e,t,o,n,s){function i(e,o){var n={conditionFn:e,loadFn:o};c.push(n),1===c.length&&t.on("window:throttledScroll",l),a()}function r(t,n,s){o.read(function(){var o=e(t),r=function(){var e=o.offset(),t=e.top-n,s=e.top+e.height+n;return m.top>t&&m.bottom<s};i(r,s)})}var a,c=[],m={top:0,bottom:0},l=function(){m.top=window.pageYOffset,m.bottom=m.top+e.viewport().height,c=n(c,function(e){return e.conditionFn()?void e.loadFn():!0}),0===c.length&&t.off("window:throttledScroll",l)};return a=s(l,2e3),{add:r}}),define("common/modules/commercial/comment-adverts",["Promise","common/utils/$","common/utils/config","common/utils/detect","common/utils/mediator","common/utils/fastdom-idle","common/modules/identity/api","common/modules/experiments/ab","common/modules/commercial/create-ad-slot","common/modules/commercial/dfp-api","common/modules/commercial/user-features","lodash/objects/defaults"],function(e,t,o,n,s,i,r,a,c,m,l,d){return function(e){var a,u,p,h,f=d(e||{},{adSlotContainerSelector:".js-discussion__ad-slot",commentMainColumn:".content__main-column"});return u=t(f.adSlotContainerSelector),p=t(f.commentMainColumn,".js-comments"),!(o.switches.standardAdverts&&o.switches.viewability&&u.length&&o.switches.discussion&&r.isUserLoggedIn()&&"childrens-books-site"!==o.page.section)||o.page.shouldHideAdverts||l.isAdfree()||o.page.isLiveBlog&&"wide"!==n.getBreakpoint()||!o.page.commentable?!1:void s.once("modules:comments:renderComments:rendered",function(){i.read(function(){return p.dim().height<280?!1:void i.write(function(){p.addClass("discussion__ad-wrapper"),o.page.isLiveBlog||p.addClass("discussion__ad-wrapper-wider"),a="comments",h=t(c(a,"mpu-banner-ad")),u.append(h),m.addSlot(h)})})})}}),define("common/utils/easing",[],function(){"use strict";function e(e,o){var n=new Date,s=t[e];return function(){var e=new Date-n;return s(Math.min(1,e/o))}}var t={linear:function(e){return e},easeInQuad:function(e){return e*e},easeOutQuad:function(e){return e*(2-e)},easeInOutQuad:function(e){return.5>e?2*e*e:-1+(4-2*e)*e},easeInCubic:function(e){return e*e*e},easeOutCubic:function(e){return--e*e*e+1},easeInOutCubic:function(e){return.5>e?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1},easeInQuart:function(e){return e*e*e*e},easeOutQuart:function(e){return 1- --e*e*e*e},easeInOutQuart:function(e){return.5>e?8*e*e*e*e:1-8*--e*e*e*e},easeInQuint:function(e){return e*e*e*e*e},easeOutQuint:function(e){return 1+--e*e*e*e*e},easeInOutQuint:function(e){return.5>e?16*e*e*e*e*e:1+16*--e*e*e*e*e}};return{functions:t,create:e}}),define("common/utils/scroller",["common/utils/easing","bonzo","fastdom"],function(e,t,o){function n(n,s,i,r){var a=t(r||document.body),c=n,m=a.scrollTop(),l=c-m,d=e.create(i||"easeOutQuad",s),u=function(){o.write(function(){a.scrollTop(m+d()*l)})},p=window.setInterval(u,15);window.setTimeout(function(){window.clearInterval(p),o.write(function(){a.scrollTop(c)})},s)}function s(e,o,s){var i=t(e).offset().top;n(i,o,s)}return{scrollToElement:s,scrollTo:n}}),define("common/modules/analytics/discussion",["bonzo","common/utils/$","common/utils/mediator","common/modules/analytics/omniture","common/modules/identity/api","lodash/functions/debounce"],function(e,t,o,n,i,r){var a={};return a.seen=!1,a.getLinkTrackVars=function(e){e=e||[];var t=["prop6","prop19","prop75","eVar8","eVar19","eVar31","eVar51","eVar66"];return","+t.concat(e).join(",")},a.comment=function(e){n.populateEventProperties("comment"),s.events+=",event51",s.linkTrackVars+=this.getLinkTrackVars(["eVar68"]),s.linkTrackEvents+=",event51",s.eVar66=i.getUserFromCookie().id||null,s.eVar68=e.replyTo?"response":"comment",s.eVar67=e.replyTo?e.replyTo.authorId:null,s.tl(!0,"o","comment")},a.recommend=function(e){n.populateEventProperties("Recommend a comment"),s.events+=",event72",s.linkTrackVars+=this.getLinkTrackVars(["eVar65","eVar67"]),s.linkTrackEvents+=",event72",s.eVar65="recommendation",s.eVar66=i.getUserFromCookie()?i.getUserFromCookie().id:null,s.eVar67=e.userId,s.tl(!0,"o","Recommend a comment")},a.jumpedToComments=function(){a.seen||(n.populateEventProperties("seen jump-to-comments"),s.events+=",event72",s.linkTrackVars+=this.getLinkTrackVars(["eVar65"]),s.linkTrackEvents+=",event72",s.eVar65="seen jump-to-comments",s.eVar66=i.getUserFromCookie()?i.getUserFromCookie().id:null,s.tl(!0,"o","seen jump-to-comments"),a.seen=!0)},a.commentPermalink=function(){a.seen||(n.populateEventProperties("seen comment-permalink"),s.events+=",event72",s.linkTrackVars+=this.getLinkTrackVars(["eVar65"]),s.linkTrackEvents+=",event72",s.eVar65="seen comment-permalink",s.eVar66=i.getUserFromCookie()?i.getUserFromCookie().id:null,s.tl(!0,"o","seen comment-permalink"),a.seen=!0)},a.scrolledToComments=function(){a.seen||(n.populateEventProperties("seen scroll-top"),s.events+=",event72",s.linkTrackVars+=this.getLinkTrackVars(["eVar65"]),s.linkTrackEvents+=",event72",s.eVar65="seen scroll-top",s.eVar66=i.getUserFromCookie()?i.getUserFromCookie().id:null,s.tl(!0,"o","seen scroll-top"),a.seen=!0)},a.areCommentsSeen=function(){var e,t=function(){a.seen||e||!a.areCommentsVisible()||(a.scrolledToComments(),o.off("window:throttledScroll",r(t,200)))};a.seen||o.on("window:throttledScroll",r(t,200))},a.areCommentsVisible=function(){var o=t("#comments").offset(),n=window.pageYOffset,s=e.viewport().height;return o.top-s/2<n&&o.top+o.height-s/3>n?!0:!1},{init:function(){o.on("discussion:commentbox:post:success",a.comment.bind(a)),o.on("discussion:comment:recommend:success",a.recommend.bind(a)),o.on("discussion:seen:comment-permalink",a.commentPermalink.bind(a)),o.on("discussion:seen:comments-anchor",a.jumpedToComments.bind(a)),o.on("discussion:seen:comments-scrolled-to",a.scrolledToComments.bind(a)),a.areCommentsSeen()}}}),define("common/modules/discussion/api",["common/modules/user-prefs","common/utils/ajax","common/utils/config","common/utils/cookies"],function(e,t,o,n){var s=function(e){return e.replace(/^http:\/\//i,"https://")},i=o.page.discussionApiRoot,r={root:i,proxyRoot:o.switches.discussionProxy?o.switches.discussionHttps?s(o.page.host+"/guardianapis/discussion/discussion-api"):o.page.host+"/guardianapis/discussion/discussion-api":i,clientHeader:o.page.discussionApiClientHeader};return r.send=function(e,o,s,i){var a=i||!1,c="post"===o||a?r.proxyRoot:r.root;s=s||{},n.get("GU_U")&&(s.GU_U=n.get("GU_U"));var m=t({url:c+e,type:"get"===o?"jsonp":"json",method:o,crossOrigin:!0,data:s,headers:{"D2-X-UID":"zHoBy6HNKsk","GU-Client":r.clientHeader},withCredentials:!0});return m},r.postComment=function(e,t){var o="/discussion/"+e+"/comment"+(t.replyTo?"/"+t.replyTo.commentId+"/reply":"");return r.send(o,"post",t)},r.previewComment=function(e){var t="/comment/preview";return r.send(t,"post",e)},r.recommendComment=function(e){var t="/comment/"+e+"/recommend";return r.send(t,"post")},r.pickComment=function(e){var t="/comment/"+e+"/highlight";return r.send(t,"post")},r.unPickComment=function(e){var t="/comment/"+e+"/unhighlight";return r.send(t,"post")},r.reportComment=function(e,t){var o="/comment/"+e+"/reportAbuse";return r.send(o,"post",t)},r.getUser=function(e){var t="/profile/"+(e?e:"me");return r.send(t,"get",null,!0)},r}),define("common/modules/discussion/user-avatars",["common/utils/$","bonzo","common/modules/discussion/api"],function(e,t,o){function n(){e(".user-avatar").each(s)}function s(e){var n=t(e),s=t(t.create('<div class="is-updating"></div>')),i=t(t.create('<img class="user-avatar__image" alt="" />')),r=n.data("userid");n.removeClass("is-hidden"),s.css("display","block").appendTo(n),o.getUser(r).then(function(e){i.attr("src",e.userProfile.secureAvatarUrl),s.remove(),i.appendTo(n)})}return{init:n,avatarify:s}}),define("common/modules/identity/validation-email",["bean","bonzo","common/utils/mediator","common/modules/identity/api"],function(e,t,o,n){return{init:function(){var s,i=document.body.querySelector(".js-id-send-validation-email");i&&(s=t(i),e.on(i,"click",function(e){e.preventDefault(),n.isUserLoggedIn()&&n.sendValidationEmail().then(function(e){"error"===e.status?(o.emit("module:identity:validation-email:fail"),s.innerHTML="An error occured, please click here to try again."):(o.emit("module:identity:validation-email:success"),s.replaceWith("<p>Sent. Please check your email and follow the link.</p>"))},function(){o.emit("module:identity:validation-email:fail"),s.innerHTML="An error occured, please click here to try again."})}))}}}),define("common/modules/discussion/comment-box",["common/utils/$","bean","bonzo","common/utils/config","common/utils/mediator","common/modules/analytics/beacon","common/modules/discussion/api","common/modules/identity/api","common/modules/component","common/modules/discussion/user-avatars","common/modules/identity/validation-email"],function(e,t,o,n,s,i,r,a,c,m,l){function d(e){this.setOptions(e),s.on("module:identity:validation-email:success",this.verificationEmailSuccess.bind(this)),s.on("module:identity:validation-email:fail",this.verificationEmailFail.bind(this))}return c.define(d),d.prototype.useBem=!0,d.prototype.templateName="comment-box",d.prototype.componentClass="d-comment-box",d.prototype.classes={},d.prototype.errorMessages={EMPTY_COMMENT_BODY:"Please write a comment.",COMMENT_TOO_LONG:"Your comment must be fewer than 5000 characters long.",HTTP_420:"You can only post one comment every minute. Please try again in a moment.",HTTP_0:"Could not post due to your internet settings, which might be controlled by your provider. Please contact your administrator or disable any proxy servers or VPNs and try again.",USER_BANNED:'Commenting has been disabled for this account (<a href="/community-faqs#321a">why?</a>).',API_ERROR:"Sorry, there was a problem posting your comment.  Please try another browser or network connection.  Reference code ",EMAIL_VERIFIED:'<span class="d-comment-box__error-meta">Sent. Please check your email to verify  your email address. Once verified post your comment.</span>',EMAIL_VERIFIED_FAIL:'We are having technical difficulties. Please try again later or <a href="/send/email" class="js-id-send-validation-email"><strong>resend the verification</strong></a>.',EMAIL_NOT_VERIFIED:'Please confirm your email address to post your first comment.<br />If you can\'t find the email, we can <a href="_#" class="js-id-send-validation-email"><strong>resend the verification email</strong></a><span class="d-comment-box__error-meta"> to  your email address.</span>'},d.prototype.defaultOptions={discussionId:null,apiRoot:null,maxLength:5e3,premod:!1,focus:!1,state:"top-level",replyTo:null,priorToVerificationDate:new Date(1392719401337)},d.prototype.errors=[],d.prototype.getUserData=function(){return a.getUserFromCookie()},d.prototype.prerender=function(){this.options.premod||this.getElem("premod").parentNode.removeChild(this.getElem("premod"));var e=this.getUserData();if(this.getElem("author").innerHTML=e.displayName,"response"===this.options.state)this.getElem("submit").innerHTML="Post reply";else{var t=this.getElem("avatar-wrapper");t.setAttribute("userid",e.id),m.avatarify(t)}if(this.options.replyTo){var o=this.getElem("reply-to-author");o.innerHTML=this.options.replyTo.author,this.getElem("parent-comment-author").innerHTML=this.options.replyTo.author+" @ "+this.options.replyTo.timestamp+" said:",this.getElem("parent-comment-body").innerHTML=this.options.replyTo.body;var n=function(){var e=o.offsetLeft+o.getBoundingClientRect().width/2;this.getElem("parent-comment-spout").style.marginLeft=e+"px"};window.setTimeout(n.bind(this),0)}},d.prototype.ready=function(){if(null===this.getDiscussionId())throw new Error('CommentBox: You need to set the "data-discussion-key" on your element');var e=this.getElem("body");this.setFormState(),t.on(document.body,"submit",[this.elem],this.postComment.bind(this)),t.on(document.body,"change keyup",[e],this.setFormState.bind(this)),t.on(e,"focus",this.setExpanded.bind(this)),this.on("change",".d-comment-box__body",this.resetPreviewComment),this.on("click",this.getClass("preview"),this.previewComment),this.on("click",this.getClass("hide-preview"),this.resetPreviewComment),this.on("click",this.getClass("cancel"),this.cancelComment),this.on("click",this.getClass("show-parent"),this.setState.bind(this,"parent-visible",!1)),this.on("click",this.getClass("hide-parent"),this.removeState.bind(this,"parent-visible",!1)),this.on("click",this.getClass("formatting-bold"),this.formatComment.bind(this,"bold")),this.on("click",this.getClass("formatting-italic"),this.formatComment.bind(this,"italic")),this.on("click",this.getClass("formatting-quote"),this.formatComment.bind(this,"quote")),this.on("click",this.getClass("formatting-link"),this.formatComment.bind(this,"link")),this.setState(this.options.state),this.options.focus&&window.setTimeout(function(){this.getElem("body").focus()}.bind(this),0)},d.prototype.urlify=function(e){var t="(?![^<]*>|[^<>]*</)",o="\\b((https?://|www.)\\S+)\\b",n=new RegExp(o+t,"g");return e.replace(n,function(e,t,o){var n="www."===o?"http://"+t:t;return'<a href="'+n+'">'+t+"</a>"})},d.prototype.postComment=function(e){var t=this,o={body:this.elem.body.value};e.preventDefault(),t.clearErrors();var n=function(){""===o.body&&t.error("EMPTY_COMMENT_BODY"),o.body.length>t.options.maxLength&&t.error("COMMENT_TOO_LONG","<b>Comments must be shorter than "+t.options.maxLength+" characters.</b>Yours is currently "+(o.body.length-t.options.maxLength)+" character(s) too long."),t.options.replyTo&&(o.replyTo=t.options.replyTo),0===t.errors.length&&(o.body=t.urlify(o.body),t.setFormState(!0),r.postComment(t.getDiscussionId(),o).then(t.postCommentSuccess.bind(t,o),t.fail.bind(t)))},s=function(){t.error("EMAIL_NOT_VERIFIED"),l.init()};if(t.getUserData().emailVerified)n();else{var i=new Date(t.getUserData().accountCreatedDate);i>t.options.priorToVerificationDate?a.getUserFromApiWithRefreshedCookie().then(function(e){e.user.statusFields.userEmailValidated===!0?n():s()}):n()}},d.prototype.error=function(e,t){"HTTP_0"===e?i.counts("comment-http-proxy-error","comment-error"):i.counts("comment-error"),t=t||this.errorMessages[e],this.setState("invalid");var n=o.create('<div class="d-discussion__error '+this.getClass("error",!0)+'"><i class="i i-alert"></i><span class="d-discussion__error-text">'+t+"</span></div>")[0];this.getElem("messages").appendChild(n),this.errors.push(e)},d.prototype.postCommentSuccess=function(e,t){i.counts("comment-post-success"),e.id=parseInt(t.message,10),this.getElem("body").value="",this.resetPreviewComment(),this.setFormState(),this.emit("post:success",e),s.emit("discussion:commentbox:post:success",e)},d.prototype.fail=function(e){var t;try{t=JSON.parse(e.responseText)}catch(o){t={}}this.setFormState(),this.errorMessages["HTTP_"+e.status]?this.error("HTTP_"+e.status):this.errorMessages[t.errorCode]?this.error(t.errorCode):this.error("API_ERROR",this.errorMessages.API_ERROR+e.status)},d.prototype.previewCommentSuccess=function(e,t){this.getElem("preview-body").innerHTML=t.commentBody,this.setState("preview-visible")},d.prototype.getDiscussionId=function(){return this.options.discussionId||this.elem.getAttribute("data-discussion-key").replace("discussion","")},d.prototype.setFormState=function(e){e="boolean"==typeof e?e:!1;var t=this.getElem("body"),o=this.getElem("submit");e||0===t.value.length?o.setAttribute("disabled","disabled"):o.removeAttribute("disabled")},d.prototype.clearErrors=function(){this.getElem("messages").innerHTML="",this.errors=[],this.removeState("invalid")},d.prototype.setExpanded=function(){this.setState("expanded")},d.prototype.verificationEmailSuccess=function(){this.clearErrors(),this.error("EMAIL_VERIFIED")},d.prototype.verificationEmailFail=function(){this.clearErrors(),this.error("EMAIL_VERIFIED_FAIL")},d.prototype.previewComment=function(e){var t=this,o={body:this.getElem("body").value};e.preventDefault(),t.clearErrors(),""===o.body&&(this.resetPreviewComment(),t.error("EMPTY_COMMENT_BODY")),o.body.length>t.options.maxLength&&t.error("COMMENT_TOO_LONG","<b>Comments must be shorter than "+t.options.maxLength+" characters.</b>Yours is currently "+(o.body.length-t.options.maxLength)+" characters too long."),0===t.errors.length&&r.previewComment(o).then(t.previewCommentSuccess.bind(t,o),t.fail.bind(t))},d.prototype.cancelComment=function(){"response"===this.options.state?this.destroy():(this.resetPreviewComment(),this.getElem("body").value="",this.setFormState(),this.removeState("expanded"))},d.prototype.resetPreviewComment=function(){this.removeState("preview-visible"),this.getElem("preview-body").innerHTML=""},d.prototype.formatComment=function(e){var t=this.getElem("body"),o=t.selectionStart,n=t.value.substring(t.selectionStart,t.selectionEnd),s=function(e,o){var s=e+n+o;t.value=t.value.substring(0,t.selectionStart)+s+t.value.substring(t.selectionEnd),r(s)},i=function(){var e,o;/^https?:\/\//i.test(n)?e=n:(o=window.prompt("Your URL:","http://www."),e=o,n=n||o);var s='<a href="'+e+'">'+n+"</a>";t.value=t.value.substring(0,t.selectionStart)+s+t.value.substring(t.selectionEnd)},r=function(e){t.setSelectionRange(o,o+e.length)};switch(e){case"bold":s("<b>","</b>");break;case"italic":
s("<i>","</i>");break;case"quote":s("<blockquote>","</blockquote>");break;case"link":i()}},d}),define("lodash/arrays/range",[],function(){function e(e,n,s){e=+e||0,s="number"==typeof s?s:+s||1,null==n&&(n=e,e=0);for(var i=-1,r=o(0,t((n-e)/(s||1))),a=Array(r);++i<r;)a[i]=e,e+=s;return a}var t=Math.ceil,o=Math.max;return e}),define("common/modules/discussion/whole-discussion",["bean","bonzo","qwery","Promise","common/utils/$","common/utils/ajax-promise","lodash/collections/forEach","lodash/arrays/range"],function(e,t,o,n,s,i,r,a){function c(e,t){return new n(function(o){function n(){c--,a.length?s(a.shift()):c||o()}function s(t){c++,e.call(null,t).then(n,n)}if(!t||!t.length)return void o();var i=t.splice(0,d),a=t,c=0;r(i,s)})}function m(e){this.discussionId=e.discussionId,this.discussion=[],this.params={orderBy:e.orderBy,displayThreaded:e.displayThreaded,maxResponses:e.maxResponses}}var l=50,d=3,u=1e3;return m.prototype.firstPageLoaded=function(e){if(this.storeCommentPage(e,1),this.discussionContainer=t.create(e.commentsHtml),this.commentsThread=s(".d-thread--comments",this.discussionContainer).empty(),this.postedCommentHtml=e.postedCommentHtml,this.lastPage=e.lastPage,e.commentCount>u)throw new Error("Discussion comment count too large");return a(2,this.lastPage+1)},m.prototype.storeCommentPage=function(e,o){var n=s(".d-thread--comments",t.create(e.commentsHtml)),i=s(".d-comment--top-level",n);"newest"===this.params.orderBy&&(i=i.map(function(e){return e}).reverse()),this.discussion[o]=i},m.prototype.loadPage=function(e){var t={orderBy:"oldest",page:e,pageSize:l,displayThreaded:this.params.displayThreaded};return this.params.maxResponses&&(t.maxResponses=this.params.maxResponses),i({url:"/discussion/"+this.discussionId+".json",type:"json",method:"get",crossOrigin:!0,data:t})},m.prototype.loadPageAndStore=function(e){return this.loadPage(e).then(function(t){this.storeCommentPage(t,e)}.bind(this))},m.prototype.loadRemainingPages=function(e){return c(this.loadPageAndStore.bind(this),e)},m.prototype.makeDiscussionResponseObject=function(){return"newest"===this.params.orderBy&&this.discussion.reverse(),this.discussion.reduce(function(e,t){return e.append(t),e},this.commentsThread),{paginationHtml:"",postedCommentHtml:this.postedCommentHtml,commentsHtml:this.discussionContainer.html(),lastPage:this.lastPage}},m.prototype.loadAllComments=function(){return this.loadPage(1).then(this.firstPageLoaded.bind(this)).then(this.loadRemainingPages.bind(this)).then(this.makeDiscussionResponseObject.bind(this))},m}),define("common/modules/discussion/comments",["bean","bonzo","qwery","common/utils/$","common/utils/ajax-promise","common/utils/config","common/utils/mediator","common/utils/scroller","common/modules/component","common/modules/discussion/api","common/modules/discussion/comment-box","common/modules/discussion/whole-discussion","common/modules/ui/relativedates","common/modules/user-prefs","common/views/svgs"],function(e,t,o,n,s,i,r,a,c,m,l,d,u,p,h){"use strict";var f="discussion.enableRelativeTimestamps",g=function(){return null!==p.get(f)?p.get(f):!0},v=function(e){this.setOptions(e)};return c.define(v),v.prototype.componentClass="d-comments",v.prototype.classes={comments:"d-thread--top-level",topLevelComment:"d-comment--top-level",reply:"d-comment--response",showReplies:"d-show-more-replies",showRepliesButton:"d-show-more-replies__button",newComments:"js-new-comments",comment:"d-comment",commentReply:"d-comment__action--reply",commentPick:"d-comment__action--pick",commentStaff:"d-comment--staff",commentBody:"d-comment__body",commentTimestampJs:"js-timestamp",commentReport:"js-report-comment"},v.prototype.defaultOptions={discussionId:null,showRepliesCount:3,commentId:null,order:"newest",threading:"collapsed"},v.prototype.comments=null,v.prototype.topLevelComments=null,v.prototype.user=null,v.prototype.ready=function(){this.topLevelComments=o(this.getClass("topLevelComment"),this.elem),this.comments=o(this.getClass("comment"),this.elem),this.on("click",this.getClass("showRepliesButton"),this.getMoreReplies),this.on("click",this.getClass("commentReport"),this.reportComment),g()&&(window.setInterval(function(){this.relativeDates()}.bind(this),6e4),this.relativeDates()),this.emit("ready"),this.on("click",".js-report-comment-close",function(){n(".js-report-comment-form").addClass("u-h")})},v.prototype.handlePickClick=function(e){e.preventDefault();var t=e.target.getAttribute("data-comment-id"),o=n(e.target),s="true"===o[0].getAttribute("data-comment-highlighted")?this.unPickComment.bind(this):this.pickComment.bind(this);s(t,o).fail(function(t){var o=t.response.length>0?JSON.parse(t.response).message:t.statusText;n(e.target).text(o)})},v.prototype.pickComment=function(e,t){var s=this,i=o("#comment-"+e,this.elem);return m.pickComment(e).then(function(){n(s.getClass("commentPick"),i).removeClass("u-h"),t.text("Unpick"),i.setAttribute("data-comment-highlighted",!0)})},v.prototype.unPickComment=function(e,t){var s=this,i=o("#comment-"+e);return m.unPickComment(e).then(function(){n(s.getClass("commentPick"),i).addClass("u-h"),t.text("Pick"),i.setAttribute("data-comment-highlighted",!1)})},v.prototype.fetchComments=function(e){e=e||{};var t="/discussion/"+(e.comment?"comment-context/"+e.comment:this.options.discussionId)+".json?"+(e.page?"&page="+e.page:""),o=e.order||this.options.order;"recommendations"===o&&(o="mostRecommended");var n={orderBy:o,pageSize:e.pagesize||this.options.pagesize,displayThreaded:"unthreaded"!==this.options.threading};e.comment||"collapsed"!==this.options.threading||(n.maxResponses=3);var i,r={url:t,type:"json",method:"get",crossOrigin:!0,data:n};return this.isAllPageSizeActive()?i=new d({discussionId:this.options.discussionId,orderBy:n.orderBy,displayThreaded:n.displayThreaded,maxResponses:n.maxResponses}).loadAllComments()["catch"](function(){return this.wholeDiscussionErrors=!0,n.pageSize=100,s(r)}.bind(this)):("All"===n.pageSize&&(n.pageSize=100),i=s(r)),i.then(this.renderComments.bind(this)).then(this.goToPermalink.bind(this,e.comment))},v.prototype.goToPermalink=function(e){e&&(this.showHiddenComments(),n(".d-discussion__show-all-comments").addClass("u-h"),window.location.replace("#comment-"+e))},v.prototype.renderComments=function(e){var n=t.create(e.commentsHtml),s=o(this.getClass("comment"),n);t(this.elem).empty().append(n),this.addMoreRepliesButtons(s),this.postedCommentEl=e.postedCommentHtml,g()&&this.relativeDates(),this.emit("rendered",e.paginationHtml),r.emit("modules:comments:renderComments:rendered")},v.prototype.showHiddenComments=function(e){e&&e.preventDefault(),this.emit("first-load"),g()&&this.relativeDates()},v.prototype.addMoreRepliesButtons=function(e){e=e||this.topLevelComments,e.forEach(function(e){var t=parseInt(e.getAttribute("data-comment-replies"),10),s=o(this.getClass("reply"),e);if(s.length<t){var i=t-s.length,r=n.create('<button class="u-button-reset button button--show-more button--small button--tone-news d-show-more-replies__button">'+h("plus",["icon"])+"Show "+i+" more "+(1===i?"reply":"replies")+"</button>").attr({"data-link-name":"Show more replies","data-is-ajax":"","data-comment-id":e.getAttribute("data-comment-id")}).data("source-comment",e);n.create('<li class="'+this.getClass("showReplies",!0)+'"></li>').append(r).appendTo(n(".d-thread--responses",e))}}.bind(this))},v.prototype.getMoreReplies=function(e){e.preventDefault();var i=n.ancestor(e.currentTarget,this.getClass("showReplies").slice(1));i.innerHTML="Loading…";var r=t(e.target).data("source-comment");s({url:"/discussion/comment/"+e.currentTarget.getAttribute("data-comment-id")+".json",type:"json",method:"get",data:{displayThreaded:!0},crossOrigin:!0}).then(function(e){var n=t.create(e.html),s=o(this.getClass("reply"),n);s=s.slice(this.options.showRepliesCount),t(o(".d-thread--responses",r)).append(s),t(i).addClass("u-h"),this.emit("untruncate-thread"),g()&&this.relativeDates()}.bind(this))},v.prototype.isReadOnly=function(){return"true"===this.elem.getAttribute("data-read-only")},v.prototype.addComment=function(e,s,i){var r,a,c,m,l,d={username:"d-comment__author",timestamp:"js-timestamp",body:"d-comment__body",report:"d-comment__action--report",avatar:"d-comment__avatar"},u={username:this.user.displayName,timestamp:"Just now",body:"<p>"+e.body.replace(/\n+/g,"</p><p>")+"</p>",report:{href:"http://discussion.theguardian.com/components/report-abuse/"+e.id},avatar:{src:this.user.avatar}},p=t.create(this.postedCommentEl)[0],h=t(p);h.addClass("d-comment--new");for(r in d)if(d.hasOwnProperty(r))if(c=d[r],a=u[r],m=o("."+c,p)[0],"string"==typeof a)m.innerHTML=a;else for(l in a)m.setAttribute(l,a[l]);p.id="comment-"+e.id,this.user&&!this.user.isStaff&&h.addClass(this.getClass("commentStaff",!0)),i?(h.removeClass(this.getClass("topLevelComment",!0)),h.addClass(this.getClass("reply",!0)),t(i).append(h)):n(this.getClass("newComments"),this.elem).prepend(p),window.location.replace("#comment-"+e.id)},v.prototype.replyToComment=function(e){e.preventDefault();var s,i,r=e.currentTarget,a=r.getAttribute("data-comment-id"),c=this;if(document.getElementById("reply-to-"+a))return void document.getElementById("reply-to-"+a).focus();n(".d-comment-box--response").remove();var m=o("#comment-"+a)[0],d=m.getAttribute("data-comment-author"),u=m.getAttribute("data-comment-author-id"),p=t(m),h=o(this.getClass("commentBody"),m)[0].innerHTML,f=o(this.getClass("commentTimestampJs"),m)[0].innerHTML,g=new l({discussionId:this.options.discussionId,premod:this.user.privateFields.isPremoderated,state:"response",replyTo:{commentId:a,author:d,authorId:u,body:h,timestamp:f},focus:!0});s=p.hasClass(this.getClass("topLevelComment",!0))?p[0]:p.parent().parent()[0],i=o(this.getClass("showReplies"),s),i.length>0&&!t(i).hasClass("u-h")&&i[0].click(),g.render(s),g.on("post:success",function(e){var n=o(".d-thread--responses",s)[0];n||(n=t.create('<ul class="d-thread d-thread--responses"></ul>')[0],t(s).append(n)),this.destroy(),c.addComment(e,!1,n)})},v.prototype.reportComment=function(o){o.preventDefault();var s=o.currentTarget.getAttribute("data-comment-id");n(".js-report-comment-form").first().each(function(o){e.one(o,"submit",function(e){e.preventDefault();var n=o.elements.category,i=o.elements.comment.value;"0"!==n.value&&m.reportComment(s,{emailAddress:o.elements.email.value,categoryId:n.value,reason:i}),t(o).addClass("u-h")})}).appendTo(n("#comment-"+s+" .js-report-comment-container").first()).removeClass("u-h")},v.prototype.addUser=function(e){this.user=e,this.user&&this.user.badge&&(this.user.isStaff=this.user.badge.some(function(e){return"Staff"===e.name})),this.isReadOnly()||this.user&&this.user.privateFields.canPostComment&&(n(this.getClass("commentReply")).attr("href","#"),this.on("click",this.getClass("commentReply"),this.replyToComment),this.on("click",this.getClass("commentPick"),this.handlePickClick))},v.prototype.relativeDates=function(){g()&&u.init()},v.prototype.isAllPageSizeActive=function(){return i.switches.discussionAllPageSize&&"All"===this.options.pagesize&&!this.wholeDiscussionErrors},v.prototype.shouldShowPageSizeMessage=function(){return i.switches.discussionAllPageSize&&"All"===this.options.pagesize&&this.wholeDiscussionErrors},v}),define("common/modules/discussion/loader",["bean","bonzo","qwery","raven","common/utils/$","common/utils/ajax-promise","common/utils/config","common/utils/detect","common/utils/mediator","common/utils/scroller","common/modules/analytics/discussion","common/modules/analytics/register","common/modules/component","common/modules/discussion/api","common/modules/discussion/comment-box","common/modules/discussion/comments","common/modules/identity/api","common/modules/user-prefs","lodash/objects/isNumber"],function(e,t,o,n,s,i,r,a,c,m,l,d,u,p,h,f,g,v,b){var y=function(){d.begin("discussion")};return u.define(y),y.prototype.classes={},y.prototype.componentClass="discussion",y.prototype.comments=null,y.prototype.user=null,y.prototype.initTopComments=function(){return this.on("click",".js-jump-to-comment",function(e){e.preventDefault(),m.scrollToElement(o(".js-discussion-toolbar"),100);var n=t(e.currentTarget).data("comment-id");this.loadComments({comment:n})}),i({url:"/discussion/top-comments/"+this.getDiscussionId()+".json",type:"json",method:"get",crossOrigin:!0}).then(function(e){this.$topCommentsContainer.html(e.html),this.topCommentCount=o(".d-top-comment",this.$topCommentsContainer[0]).length,0!==this.topCommentCount&&this.setState("has-top-comments")}.bind(this))},y.prototype.initMainComments=function(){var e=this.getCommentIdFromHash();e&&c.emit("discussion:seen:comment-permalink");var i=v.get("discussion.order")||(this.getDiscussionClosed()?"oldest":"newest"),m=v.get("discussion.threading")||"collapsed",l=a.isBreakpoint({min:"tablet"})?25:10;this.comments=new f({discussionId:this.getDiscussionId(),order:i,pagesize:l,threading:m}),this.comments.attachTo(o(".js-discussion-main-comments")[0]),this.comments.on("untruncate-thread",this.removeTruncation.bind(this)),this.on("click",".js-discussion-show-button, .d-show-more-replies__button, .js-discussion-author-link, .js-discussion-change-page",this.removeTruncation.bind(this)),this.comments.on("rendered",function(e){var n=t.create(e),i=o(".js-discussion-toolbar",this.elem)[0],r=s(".js-discussion-pagination",i).empty();this.comments.isAllPageSizeActive()||r.html(n)}.bind(this)),this.setState("loading"),this.on("user:loaded",function(){if(this.initState(),this.renderCommentBar(),this.user){this.comments.addUser(this.user);var t=v.get("discussion.pagesize"),o=l;b(t)?o=t:"All"===t&&(o=r.switches.discussionAllPageSize?"All":100),this.initPageSizeDropdown(o),r.switches.discussionPageSize&&a.isBreakpoint({min:"tablet"})&&(this.comments.options.pagesize=o),this.user.isStaff&&(this.removeState("not-staff"),this.setState("is-staff"))}var s=!e&&"#comments"!==window.location.hash;this.loadComments({comment:e,shouldTruncate:s})["catch"](function(e){var t="Comments failed to load: ",o=e.request;t+="Request is aborted: timeout"===e.message?"XHR timeout":e.message?e.message:"status"in o?o.status:"",n.captureMessage(t,{tags:{contentType:"comments",discussionId:this.getDiscussionId(),status:"status"in o?o.status:"",readyState:"readyState"in o?o.readyState:"",response:"response"in o?o.response:"",statusText:"status"in o?o.statusText:""}})}.bind(this))}),this.getUser()},y.prototype.initPageSizeDropdown=function(n){var i=s(".js-comment-pagesize");i.text(n),this.on("click",".js-comment-pagesize-dropdown .popup__action",function(n){e.fire(o(".js-comment-pagesize-dropdown [data-toggle]")[0],"click");var s=t(n.currentTarget).data("pagesize");this.comments.options.pagesize=s,i.text(s),v.set("discussion.pagesize",s),this.loadComments({page:1})})},y.prototype.initToolbar=function(){var n=s(".js-comment-order");n.text(this.comments.options.order),this.on("click",".js-comment-order-dropdown .popup__action",function(s){e.fire(o(".js-comment-order-dropdown [data-toggle]")[0],"click"),this.comments.options.order=t(s.currentTarget).data("order"),n.text(this.comments.options.order),v.set("discussion.order",this.comments.options.order),this.loadComments({page:1})});var i=s(".js-comment-threading");if(i.text(this.comments.options.threading),this.on("click",".js-comment-threading-dropdown .popup__action",function(n){e.fire(o(".js-comment-threading-dropdown [data-toggle]")[0],"click"),this.comments.options.threading=t(n.currentTarget).data("threading"),i.text(this.comments.options.threading),v.set("discussion.threading",this.comments.options.threading),this.loadComments()}),"crosswords"===r.page.section){var a=s(".js-timestamps"),c=function(e){a.text(e?"Relative":"Absolute")};c(l);var m="discussion.enableRelativeTimestamps",l=null!==v.get(m)?v.get(m):!0;c(l),this.on("click",".js-timestamps-dropdown .popup__action",function(n){e.fire(o(".js-timestamps-dropdown [data-toggle]")[0],"click");var s=t(n.currentTarget).data("timestamp"),i="relative"===s;c(i),v.set(m,i),this.loadComments()})}},y.prototype.isOpenForRecommendations=function(){return 0!==o(".d-discussion--recommendations-open",this.elem).length},y.prototype.initRecommend=function(){this.on("click",".js-recommend-comment",function(e){if(this.user&&this.isOpenForRecommendations()){var o=e.currentTarget,n=t(o);n.removeClass("js-recommend-comment");var s=o.getAttribute("data-comment-id"),i=p.recommendComment(s);return n.addClass("d-comment__recommend--clicked"),i.then(n.addClass.bind(n,"d-comment__recommend--recommended"))}})},y.prototype.ready=function(){this.$topCommentsContainer=s(".js-discussion-top-comments"),this.initTopComments(),this.initMainComments(),this.initToolbar(),this.renderCommentCount(),this.initPagination(),this.initRecommend(),l.init(),e.on(window,"hashchange",function(){var e=this.getCommentIdFromHash();e&&this.gotoComment(e)}.bind(this)),"#comments"===window.location.hash&&c.emit("discussion:seen:comments-anchor"),c.on("discussion:commentbox:post:success",this.removeState.bind(this,"empty")),c.on("module:clickstream:click",function(e){"hash"in e.target&&"#comments"===e.target.hash&&this.removeTruncation()}.bind(this)),d.end("discussion")},y.prototype.getUser=function(){g.getUserFromCookie()?p.getUser().then(function(e){this.user=e.userProfile,this.emit("user:loaded")}.bind(this)):this.emit("user:loaded")},y.prototype.isCommentable=function(){var e=this.user&&this.user.privateFields&&this.user.privateFields.canPostComment;return e&&!this.comments.isReadOnly()&&!this.getDiscussionClosed()},y.prototype.initState=function(){this.getDiscussionClosed()?this.setState("closed"):this.comments.isReadOnly()?this.setState("readonly"):g.getUserFromCookie()&&this.user&&this.user.privateFields&&!this.user.privateFields.canPostComment?this.setState("banned"):this.setState("open")},y.prototype.renderCommentBar=function(){this.isCommentable()&&(this.renderCommentBox(o(".js-discussion-comment-box--top")[0]),this.renderCommentBox(o(".js-discussion-comment-box--bottom")[0]))},y.prototype.commentPosted=function(){this.removeState("truncated"),this.comments.addComment.apply(this.comments,arguments)},y.prototype.renderCommentBox=function(e){return new h({discussionId:this.getDiscussionId(),premod:this.user.privateFields.isPremoderated}).render(e).on("post:success",this.commentPosted.bind(this))},y.prototype.getDiscussionId=function(){return this.elem.getAttribute("data-discussion-key")},y.prototype.getDiscussionClosed=function(){return"true"===this.elem.getAttribute("data-discussion-closed")},y.prototype.renderCommentCount=function(){i({url:"/discussion/comment-counts.json?shortUrls="+this.getDiscussionId(),type:"json",method:"get",crossOrigin:!0,success:function(e){if(e&&e.counts&&e.counts.length){var n=e.counts[0].count;if(n>0){t(o(".js-show-discussion, .js-show-discussion a")).attr("href","#comments");var i=1===n?"comment":"comments",r='<a href="#comments" class="js-show-discussion commentcount tone-colour" data-link-name="Comment count">  <i class="i"></i>'+n+'  <span class="commentcount__label">'+i+"</span></a>";s(".js-comment-count").html(r),s(".js-discussion-comment-count").text("("+n+")")}else this.setState("empty")}}.bind(this)})},y.prototype.getCommentIdFromHash=function(){var e=/#comment-(\d+)/;return e.exec(window.location.hash)?parseInt(e.exec(window.location.hash)[1],10):null},y.prototype.initPagination=function(){this.on("click",".js-discussion-change-page",function(e){e.preventDefault();var t=parseInt(e.currentTarget.getAttribute("data-page"),10);this.setState("loading"),this.gotoPage(t)})},y.prototype.gotoComment=function(e){var t=s("#comment-"+e,this.elem);return t.length>0?void window.location.replace("#comment-"+e):void this.loadComments({comment:e}).then(function(){window.location.replace("#comment-"+e)})},y.prototype.gotoPage=function(e){m.scrollToElement(o(".js-discussion-toolbar"),100),this.comments.relativeDates(),this.loadComments({page:e})},y.prototype.loadComments=function(e){return this.setState("loading"),e&&e.shouldTruncate&&this.comments.isAllPageSizeActive()&&(e.pageSize=10),this.comments.fetchComments(e).then(function(){this.removeState("loading"),e&&e.shouldTruncate?this.setState("truncated"):this.removeState("truncated"),this.comments.shouldShowPageSizeMessage()?this.setState("pagesize-msg-show"):this.removeState("pagesize-msg-show")}.bind(this))},y.prototype.removeTruncation=function(){this.comments.isAllPageSizeActive()?this.loadComments():this.removeState("truncated")},y}),define("lodash/arrays/union",["../internals/baseFlatten","../internals/baseUniq"],function(e,t){function o(){return t(e(arguments,!0,!0))}return o}),define("common/modules/onward/onward-content",["common/utils/config","common/utils/mediator","common/modules/analytics/register","common/modules/commercial/badges","common/modules/component","lodash/arrays/union"],function(e,t,o,n,s,i){function r(t){o.begin("series-content"),this.context=t,this.endpoint="/series/"+a()+".json?shortUrl="+encodeURIComponent(e.page.shortUrl),this.fetch(this.context,"html")}var a=function(){var t=e.page.blogIds.split(",").concat([e.page.seriesId]);return i(e.page.nonKeywordTagIds.split(","),t).shift()};return s.define(r),r.prototype.ready=function(e){n.add(e),o.end("series-content"),t.emit("modules:onward:loaded"),t.emit("page:new-content"),t.emit("ui:images:upgradePictures")},r.prototype.error=function(){o.error("series-content")},r}),define("common/modules/onward/inject-container",["fastdom","common/utils/$","common/utils/ajax","common/utils/config","common/modules/ui/images","common/utils/mediator"],function(e,t,o,n,s,i){function r(r,a,c){return o({url:r,crossOrigin:!0}).then(function(o){o.html&&e.write(function(){var e=t(a),r=o.html.replace(/js-ad-slot ad-slot ad-slot--dfp/g,"");e.after(r.replace(/js-fc-slice-mpu-candidate/g,"")),n.page&&n.page.hasStoryPackage||e.css({display:"none"}),s.upgradePictures(),i.emit(c)})})}return{injectContainer:r}}),define("common/modules/onward/popular",["qwery","common/utils/$","common/utils/config","common/utils/detect","common/modules/component","common/utils/mediator","common/modules/commercial/create-ad-slot","common/modules/commercial/commercial-features","common/modules/commercial/dfp-api","common/modules/experiments/ab","common/modules/onward/inject-container","lodash/collections/contains"],function(e,t,o,n,s,i,r,a,c,m,l,d){function u(){var e=["info","global"];i.emit("register:begin","popular-in-section"),this.hasSection=o.page&&o.page.section&&!d(e,o.page.section),this.endpoint="/most-read"+(this.hasSection?"/"+o.page.section:"")+".json"}return s.define(u),u.prototype.init=function(){m.getParticipations().InjectNetworkFrontTest2&&"variant"===m.getParticipations().InjectNetworkFrontTest2.variant&&m.testCanBeRun("InjectNetworkFrontTest2")?t(".js-most-popular-footer").hide():this.fetch(e(".js-popular-trails"),"html")},u.prototype.mobileMaximumSlotsReached=function(){return"mobile"===n.getBreakpoint()&&t(".ad-slot--inline").length>1},u.prototype.prerender=function(){if(a.popularContentMPU&&!this.mobileMaximumSlotsReached()){var e=t(".js-fc-slice-mpu-candidate",this.elem);this.$mpu=e.append(r("mostpop","container-inline"))}else this.$mpu=void 0},u.prototype.ready=function(){this.$mpu&&(c.addSlot(t(".ad-slot",this.$mpu)),this.$mpu.removeClass("fc-slice__item--no-mpu")),i.emit("modules:popular:loaded",this.elem),i.emit("page:new-content",this.elem),i.emit("register:end","popular-in-section")},u}),define("common/modules/ui/expandable",["common/utils/$","bean","bonzo"],function(e,t,o){var n=function(n){var s=n||{},i=e(s.dom),r=s.expanded===!1?!1:!0,a=document.createElement("button"),c=s.showCount===!1?!1:!0,m={updateCallToAction:function(){var e="Show ";c&&(e+=l.getCount()+" "),e+=r?"fewer":"more",a.innerHTML=e,a.setAttribute("data-link-name","Show "+(r?"more":"fewer")),a.setAttribute("data-is-ajax","1")},renderState:function(){r?i.removeClass("shut"):i.addClass("shut")},renderCallToAction:function(){t.add(a,"click",function(){l.toggleExpanded()}),a.className="cta",s.buttonAfterEl?o(s.buttonAfterEl).after(a):i[0].appendChild(a),m.updateCallToAction()},scrollToCallToAction:function(){r||window.setTimeout(function(){a.scrollIntoView()},550)}},l={toggleExpanded:function(){r=r?!1:!0,m.renderState(),m.updateCallToAction()},getCount:function(){return parseInt(i.attr("data-count"),10)},isOpen:function(){return i.hasClass("shut")?!1:!0}};return{init:function(){return i.hasClass("expandable-initialised")||!i.html()||l.getCount()<3?!1:(i.addClass("expandable-initialised"),m.renderCallToAction(),void m.renderState())},toggle:l.toggleExpanded}};return n}),define("common/modules/onward/related",["bonzo","qwery","common/utils/$","common/utils/config","common/utils/mediator","common/modules/analytics/register","common/modules/lazyload","common/modules/ui/expandable","common/modules/experiments/ab","lodash/arrays/intersection","lodash/collections/map"],function(e,t,o,n,s,i,r,a,c,m,l){function d(e){u=e||{}}var u;return d.prototype.popularInTagOverride=function(){if(!n.page.keywordIds)return!1;var e=["sport/cricket","sport/rugby-union","sport/rugbyleague","sport/formulaone","sport/tennis","sport/cycling","sport/motorsports","sport/golf","sport/horse-racing","sport/boxing","sport/us-sport","sport/australia-sport","football/championsleague","football/premierleague","football/championship","football/europeanfootball","football/world-cup-2014","football/manchester-united","football/chelsea","football/arsenal","football/manchestercity","football/tottenham-hotspur","football/liverpool"],t=n.page.keywordIds.split(","),o=n.page.isAdvertisementFeature?t:m(e,t);return o.length?"/popular-in-tag/"+o[0]+".json":void 0},d.prototype.renderRelatedComponent=function(){var t,m,d,p,h,f=n.switches.relatedContent&&n.page.showRelatedContent;if(n.page&&n.page.hasStoryPackage)new a({dom:document.body.querySelector(".related-trails"),expanded:!1,showCount:!1}).init();else if(!f||c.getParticipations().InjectNetworkFrontTest2&&"variant"===c.getParticipations().InjectNetworkFrontTest2.variant&&c.testCanBeRun("InjectNetworkFrontTest2"))o(".js-related").addClass("u-h");else if(p=document.body.querySelector(".js-related")){if(m=this.popularInTagOverride(),d=m?"related-popular-in-tag":"related-content",i.begin(d),p.setAttribute("data-component",d),c.getParticipations().EssentialReadTest1&&("automated"===c.getParticipations().EssentialReadTest1.variant||"curated"===c.getParticipations().EssentialReadTest1.variant)&&c.testCanBeRun("EssentialReadTest1")){switch(n.page.edition){case"UK":h="/uk.json";break;case"US":h="/us.json";break;case"AU":h="/au.json";break;case"INT":h="/international.json"}"automated"===c.getParticipations().EssentialReadTest1.variant?t="/container/essential-read/automated"+h:"curated"===c.getParticipations().EssentialReadTest1.variant&&(t="/container/essential-read/curated"+h)}else t=m||"/related/"+n.page.pageId+".json",u.excludeTags&&u.excludeTags.length&&(t+="?"+l(u.excludeTags,function(e){return"exclude-tag="+e}).join("&"));new r({url:t,container:p,success:function(){var e=p.querySelector(".related-content");new a({dom:e,expanded:!1,showCount:!1}).init(),s.emit("modules:related:loaded",p),s.emit("page:new-content",p),s.emit("ui:images:upgradePictures",p),i.end(d)},error:function(){e(p).remove(),i.error(d)}}).load()}},d}),define("common/modules/onward/tonal",["common/utils/config","common/utils/mediator","common/modules/analytics/register","common/modules/component"],function(e,t,o,n){function s(){o.begin("tonal-content"),this.edition=e.page.edition.toLowerCase(),this.isSupported()?this.endpoint=this.getEndpoint():this.fetch=i}var i=function(){};return n.define(s),s.prototype.tones={features:"-alpha/features/feature-stories.json",comment:"-alpha/contributors/feature-stories.json"},s.prototype.getEndpoint=function(){return"/container/"+this.edition+this.tones[this.getTone()]},s.prototype.isSupported=function(){return this.getTone()in this.tones},s.prototype.getTone=function(){return e.page.tones.split(",")[0].toLowerCase()},s.prototype.ready=function(){var e=document.body.querySelector(".tone-feature");t.emit("page:new-content",e),t.emit("ui:images:upgradePictures"),t.emit("modules:tonal:loaded"),o.end("tonal-content")},s.prototype.error=function(){o.error("tonal-content")},s}),define("text!common/views/content/share-count.html",[],function(){return'<h3 class="sharecount__heading"><i class="i"></i>Shares</h3>\n<div class="sharecount__value sharecount__value--full">0</div>\n<div class="sharecount__value sharecount__value--short">0</div>'}),define("text!common/views/content/share-count-immersive.html",[],function(){return'<%= icon %><span class="sharecount__value sharecount__value--short">0</span> Shares\n'}),define("common/modules/social/share-count",["common/utils/report-error","common/utils/$","common/utils/ajax","common/utils/detect","common/utils/config","common/utils/formatters","common/utils/template","common/views/svgs","text!common/views/content/share-count.html","text!common/views/content/share-count-immersive.html"],function(e,t,o,n,s,i,r,a,c,m){function l(e){if(0!==e){f+=e;var t=f.toFixed(0),o=i.integerCommas(t),n=t>1e4?Math.round(t/1e3)+"k":t;p.text(o),h.text(n)}}function d(){g.attr("title",r(v,b))}function u(e){if(g.hasClass("js-sharecount-immersive")&&(c=r(m,{icon:a("share")})),g.removeClass("u-h").html(c).css("display",""),h=t(".sharecount__value--short",g[0]),p=t(".sharecount__value--full",g[0]),n.isBreakpoint({min:"tablet"}))var o=250,s=25,i=o/s,d=e/i,u=0,f=window.setInterval(function(){l(d),++u===i&&window.clearInterval(f)},s);else l(e)}var p,h,f=0,g=t(".js-sharecount"),v="Facebook: <%=facebook%> \nTwitter: <%=twitter%>",b={facebook:"n/a",twitter:"n/a"};return function(){if(g.length&&!s.page.isPreview){var t="http://www.theguardian.com/"+s.page.pageId;try{o({url:"https://graph.facebook.com/"+t,type:"json",method:"get",crossOrigin:!0}).then(function(e){var t=e.shares||0;b.facebook=t,u(t),d()}),o({url:"https://cdn.api.twitter.com/1/urls/count.json?url="+t,type:"jsonp",method:"get",crossOrigin:!0}).then(function(e){var t=e.count||0;b.twitter=t,u(t),d()})}catch(n){e(new Error("Error retrieving share counts ("+n.message+")"),{feature:"share-count"},!1)}}}}),define("bootstraps/trail",["enhancer","fastdom","qwery","common/utils/$","common/utils/config","common/utils/contains","common/utils/mediator","common/utils/robust","common/utils/proximity-loader","common/utils/detect","common/modules/commercial/comment-adverts","common/modules/discussion/loader","common/modules/identity/api","common/modules/onward/onward-content","common/modules/onward/popular","common/modules/onward/related","common/modules/onward/tonal","common/modules/social/share-count","common/modules/onward/inject-container","common/modules/experiments/ab"],function(e,t,o,n,s,i,r,a,c,m,l,d,u,p,h,f,g,v,b,y){function w(e,t){if(window.location.hash)t();else{var n=o(e)[0];n&&c.add(n,1500,t)}}function C(){s.page.isFront||w(".js-popular-trails",function(){(new h).init()})}function k(){if(s.page.seriesId||s.page.blogIds||w(".js-related",function(){var e={excludeTags:[]};"advertisement-features"!==s.page.sponsorshipType&&e.excludeTags.push("tone/advertisement-features"),"contentType"in s.page&&i(["video","interactive"],s.page.contentType.toLowerCase())&&e.excludeTags.push("guardian-professional/guardian-professional"),new f(e).renderRelatedComponent()}),y.getParticipations().InjectNetworkFrontTest2&&"variant"===y.getParticipations().InjectNetworkFrontTest2.variant&&y.testCanBeRun("InjectNetworkFrontTest2")){var e;switch(s.page.edition){case"UK":e="/uk.json";break;case"US":e="/us.json";break;case"AU":e="/au.json";break;case"INT":e="/international.json"}(s.page.seriesId||s.page.blogIds)&&n(".onward").insertBefore(o(".js-related")),b.injectContainer(e,".related","ab-network-front-loaded"),r.once("ab-network-front-loaded",function(){var e=n(".facia-page");e.addClass("ab-front-injected"),e.attr("data-link-name",e.attr("data-link-name")+" | ab-front-injected-2"),n(".js-tabs-content",e).addClass("tabs__content--no-border"),
n(".js-tabs",e).addClass("u-h")}.bind(this))}}function T(){w(".js-onward",function(){(s.page.seriesId||s.page.blogIds)&&s.page.showRelatedContent?new p(o(".js-onward")):""!==s.page.tones&&n(".js-onward").each(function(e){(new g).fetch(e,"html")})})}function j(){if(s.switches.discussion&&s.page.commentable){var e=o(".discussion")[0];e&&(new d).attachTo(e)}}function S(){/Article|Interactive|LiveBlog/.test(s.page.contentType)&&n("figure.interactive").each(function(o){t.defer(function(){e.render(o,document,s,r)})})}function E(){u.isUserLoggedIn()||t.write(function(){n(".js-comments").appendTo(o(".js-repositioned-comments"))})}return function(){a.catchErrorsAndLogAll([["c-discussion",j],["c-comments",E],["c-enhance",S],["c-shares",v],["c-popular",C],["c-related",k],["c-onward",T],["c-comment-adverts",l]])}}),define("bootstraps/article",["qwery","bean","common/utils/$","common/utils/config","common/utils/detect","common/utils/mediator","common/utils/url","common/modules/article/rich-links","common/modules/article/membership-events","common/modules/article/open-module","common/modules/article/chapters","common/modules/experiments/ab","common/modules/onward/geo-most-popular","bootstraps/article-liveblog-common","bootstraps/trail"],function(e,t,o,n,s,i,r,a,c,m,l,d,u,p,h){var f={initCmpParam:function(){var e=r.getUrlVars();e.CMP&&o(".element-pass-cmp").each(function(t){t.src=t.src+"?CMP="+e.CMP})},initRightHandComponent:function(){var t=e(".js-content-main-column");t[0]&&t[0].offsetHeight>1150&&s.isBreakpoint({min:"desktop"})&&u.render()},initQuizListeners:function(){require(["ophan/ng"],function(e){i.on("quiz/ophan-event",e.record)})}},g=function(){h(),p(),f.initRightHandComponent(),f.initCmpParam(),f.initQuizListeners(),a.upgradeRichLinks(),a.insertTagRichLink(),c.upgradeEvents(),l.init(),m.init(),i.emit("page:article:ready")};return{init:g,modules:f}});
//# sourceMappingURL=article.js.map